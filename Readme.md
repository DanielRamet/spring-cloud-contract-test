# Spring cloud contract test

Simple spring boot application to test Spring cloud contract
The idea is a proof of concepts about using a producer ("provider") and a
consumer. 
- The provider is a Rest spring boot app with two endpoints:
 ```bash
GET /person/{id} 

returns a person with the Id given. 
In case the parameter is negative, the response is a bad request (400) with a ContractError as body. 
```

 ```bash
POST /person 

Throws always an error (CustomExceptionNotFound exception)
```

This project defines with .groovy contracts to define behavior of the operations above.

- The consumer will download the stubs.jar generated by the producer and confirm the behavior.

## Installation

Use maven simple build

```bash
mvn clean install
```
- For provider app, it is possible to run a embedded tomcat spring boot app:
```bash
mvn spring-boot:run
```
- The consumer project is just to verify the contract provided with the tests.

## Notes
For spring cloud contract, the exceptions when are defined with the corresponding generated tests:

If we use custom exceptions defined as:
```bash
@ResponseStatus(value = HttpStatus.BAD_REQUEST, reason = "Bad Id requested")
public class CustomException extends RuntimeException {
```

The embedded tomcat with default configuration, it uses the exception handler with the response as follows:

```bash
{
"timestamp": "2021-04-06T07:42:00.845+00:00",
"status": 400,
"error": "Bad Request",
"message": "Bad Id requested",
"path": "/person/-1"
}
}
```

On the other hand, using MockMvc to generate contract tests does not have any dispatch where wrap the Exception responses.
That means the response entity to validate only the status (HttpStatus.{status}).

In case that, by default, we want to have wrapped the exceptions, the solution would be to return directly ResponseEntity object
with the HttpStatus required. (see GET /person/{id} for details).

In case it uses custom exceptions and the MockMvc uses a dispatch just to define contracts, then, we will need to set
an @ControllerAdvice to handle exceptions, like the following excample:

```bash
@ControllerAdvice
class ExceptionController {

    @ExceptionHandler(CustomExceptionNotFound.class)
    @ResponseStatus(value = HttpStatus.NOT_FOUND)
    @ResponseBody
    public ResponseEntity handleException(CustomExceptionNotFound ex) {
        return ResponseEntity.status(HttpStatus.NOT_FOUND).contentType(MediaType.APPLICATION_JSON)
                .body(ex);
    }

    @ExceptionHandler(CustomException.class)
    @ResponseStatus(value = HttpStatus.BAD_REQUEST)
    @ResponseBody
    public ResponseEntity handleException2(CustomException ex) {
        return ResponseEntity.status(HttpStatus.BAD_REQUEST).contentType(MediaType.APPLICATION_JSON)
                .body(ex);
    }
}
```
